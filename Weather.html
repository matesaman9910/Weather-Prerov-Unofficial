<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P≈ôerov Weather ‚Äî Rain‚ÄëFirst</title>
  <meta name="description" content="YES/NO rain for P≈ôerov ‚Äî start ‚Ä¢ peak ‚Ä¢ end. Confidence signal. Hourly precip, temp+wind, 7‚Äëday outlook, UV, sun+moon, air quality, pollen, pressure trend, radar. Mobile‚Äëfirst." />
  <meta name="theme-color" content="#0b1020">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://api.open-meteo.com https://air-quality-api.open-meteo.com https://weatherwebsiteprerov.matejkratochvilbilina.workers.dev; img-src 'self' data:; style-src 'self' 'unsafe-inline'; frame-src https://radar.bourky.cz; base-uri 'none'; form-action 'none'">
  <style>
    :root{ --bg:#0b1020; --card:#111731; --ink:#e8ecff; --muted:#b6c0ff; --line:#2b345c; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#77a8ff; --radius:18px; --glow: transparent; --glowAlpha: 0 }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Noto Sans,Arial;color:var(--ink);
      background:
        radial-gradient(1100px 700px at 10% -10%, #243056 10%, transparent 60%),
        radial-gradient(900px 700px at 110% 10%, #1a1f35 5%, transparent 60%),
        linear-gradient(180deg,#0b1020,#0a0f1e);
      animation:bgShift 14s ease-in-out infinite alternate;
      position:relative;}
    body::after{content:"";pointer-events:none;position:fixed;inset:0;z-index:0;
      background:
        radial-gradient(1200px 200px at 50% -100px, color-mix(in oklab, var(--glow) 70%, transparent) var(--glowAlpha), transparent 70%),
        radial-gradient(1200px 200px at 50% calc(100% + 100px), color-mix(in oklab, var(--glow) 70%, transparent) var(--glowAlpha), transparent 70%),
        radial-gradient(200px 1200px at -100px 50%, color-mix(in oklab, var(--glow) 70%, transparent) var(--glowAlpha), transparent 70%),
        radial-gradient(200px 1200px at calc(100% + 100px) 50%, color-mix(in oklab, var(--glow) 70%, transparent) var(--glowAlpha), transparent 70%);
      opacity:.95;transition:background .4s ease}
    @keyframes bgShift{from{background-position:0 0,0 0,0 0}to{background-position:20px -10px,-20px 10px,0 0}}
    a{color:var(--accent)}
    .wrap{max-width:1240px;margin:0 auto;padding:22px;position:relative;z-index:1}
    .row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(340px,1fr))}
    .hero{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .card{background:linear-gradient(180deg,#16203b,#0f1630);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px #0006;opacity:0;transform:translateY(8px);transition:opacity .5s ease,transform .5s ease}
    .card.reveal{opacity:1;transform:translateY(0)}
    h1{margin:0;font-size:clamp(22px,2.6vw,32px)} h2{margin:0 0 10px 0;font-size:20px}
    .sub{color:var(--muted);font-size:14px}

    .topbar{position:sticky;top:0;z-index:20;padding-top:8px;backdrop-filter:blur(6px)}
    .barRow{display:flex;gap:10px;align-items:stretch;justify-content:space-between;margin-bottom:12px}
    .banner{flex:1;display:flex;gap:10px;align-items:flex-start;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:14px 16px;line-height:1.25;font-size:clamp(15px,3.2vw,19px);max-height:64px;overflow:hidden;box-shadow:inset 0 0 0 1px #0003}
    .banner.expand{max-height:none}
    .banner .left{display:flex;gap:10px;align-items:flex-start}
    .banner .ico{font-size:22px;line-height:1}
    .banner.green{background:#0f2818;color:#c9ffe0;border-color:#1b5e33}
    .banner.yellow{background:#2e2609;color:#ffe7b5;border-color:#7a5c12}
    .banner.orange{background:#2e1b08;color:#ffd6b3;border-color:#9c5416}
    .banner.red{background:#2d0d0d;color:#ffd0d0;border-color:#8a1f1f}
    .banner.gray{background:#0f1430;color:#c5d1ff;border-color:#323c6c}
    #alertText{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

    .answer{font-weight:800;letter-spacing:.6px;font-size:clamp(34px,7vw,60px);padding:12px 16px;border-radius:16px;background:#1a2344;min-width:170px;text-align:center;border:1px solid var(--line)}
    .answer.ok{background:#142a1b;border-color:#1b5e33}
    .answer.warn{background:#2f260e;border-color:#7a5c12}
    .answer.bad{background:#2f1414;border-color:#8a1f1f}
    .reason{color:var(--muted);font-size:14px;margin-top:8px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:13px;color:#d8e0ff;background:#111836}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}

    .chart{height:240px}
    .chartSmall{height:200px}
    .badge{display:inline-block;border:1px solid var(--line);padding:3px 10px;border-radius:999px;font-size:13px;margin-right:8px}
    .b-good{background:#0f2818;color:#c9ffe0;border-color:#1b5e33}
    .b-fair{background:#2e2609;color:#ffe7b5;border-color:#7a5c12}
    .b-mod{background:#2e1b08;color:#ffd6b3;border-color:#9c5416}
    .b-poor{background:#2d0d0d;color:#ffd0d0;border-color:#8a1f1f}
    .level{display:inline-block;border-radius:8px;padding:3px 10px;font-size:13px;margin-left:8px;border:1px solid var(--line}
    .level.green{background:#0f2818;color:#c9ffe0;border-color:#1b5e33}
    .level.yellow{background:#2e2609;color:#ffe7b5;border-color:#7a5c12}
    .level.orange{background:#2e1b08;color:#ffd6b3;border-color:#9c5416}
    .level.red{background:#2d0d0d;color:#ffd0d0;border-color:#8a1f1f}

    .days{display:flex;flex-wrap:wrap;justify-content:center;gap:12px;padding:6px 6px 10px}
    .day{min-width:140px;background:#0f1731;border:1px solid var(--line);border-radius:14px;padding:12px;text-align:center}
    .day .w{font-size:28px;margin:2px 0}
    .day .t{font-size:16px}

    .btn{appearance:none;border:1px solid var(--line);background:#0f1731;color:var(--ink);border-radius:999px;padding:9px 14px;font-size:14px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}

    .radarWrap{display:flex;flex-direction:column;gap:10px}
    iframe.radar{width:100%;height:420px;border:1px solid var(--line);border-radius:14px;background:#0b0f1a}

    .toolbar{display:flex;gap:10px;align-items:center}
    .statusDot{width:10px;height:10px;border-radius:50%;border:1px solid #0006}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#2c1a1a;color:#ffd0d0;border:1px solid #8a1f1f;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px #0008;z-index:50;display:none}
    .toast.show{display:block}

    footer{color:#9fb0ff8c;font-size:12px;margin:22px 0 8px;line-height:1.6;text-align:center}

    @media (max-width:480px){.chart{height:200px}.chartSmall{height:160px}.card{padding:14px}.banner{max-height:56px}}
    @media (prefers-reduced-motion:reduce){.card{transition:none}body{animation:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="barRow">
        <div id="alertBar" class="banner gray" aria-live="polite">
          <div class="left"><div class="ico">‚ö†Ô∏è</div><div id="alertText">Checking alerts‚Ä¶</div></div>
          <div class="toolbar">
            <div id="alertUntil" class="chip" style="display:none"></div>
          </div>
        </div>
        <div class="sub" id="asof">‚Äî <span class="statusDot" id="statusDot"></span></div>
      </div>
    </div>

    <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
      <div>
        <h1 style="letter-spacing:.3px">P≈ôerov Weather ‚Äî Rain‚ÄëFirst</h1>
        <div class="sub">YES only when it will actually rain ‚Äî start ‚Ä¢ peak ‚Ä¢ end. Confidence signal. Mobile‚Äëfriendly.</div>
      </div>
      <button id="shareBtn" class="btn" title="Share today‚Äôs status">Share</button>
    </header>

    <section class="hero">
      <div class="card reveal">
        <h2>üåßÔ∏è Will it rain <strong>today</strong> in P≈ôerov?</h2>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <div id="rainToday" class="answer">‚Ä¶</div>
            <div id="reasonToday" class="reason">Scanning next hours‚Ä¶</div>
            <div class="chips"><span id="confToday" class="chip">Confidence ‚Äî</span></div>
          </div>
          <div><div id="highlightsToday" class="sub"></div></div>
        </div>
      </div>
      <div class="card reveal">
        <h2>üåßÔ∏è Will it rain <strong>tomorrow</strong>?</h2>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <div id="rainTomorrow" class="answer">‚Ä¶</div>
            <div id="reasonTomorrow" class="reason">Scanning tomorrow‚Ä¶</div>
            <div class="chips"><span id="confTomorrow" class="chip">Confidence ‚Äî</span></div>
          </div>
          <div><div id="highlightsTomorrow" class="sub"></div></div>
        </div>
      </div>
    </section>

    <section class="row" style="margin-top:14px">
      <div class="card">
        <h2>üìà Hourly precip (next 24h)</h2>
        <canvas id="rainChart" class="chart" aria-label="Hourly precipitation"></canvas>
        <div class="sub">Bars: precipitation (mm). Line: probability (%). YES only if ‚â•0.2 mm/h & ‚â•40% PoP, or ‚â•0.6 mm/h; heavy ‚â•1.0 mm/h.</div>
      </div>
      <div class="card">
        <h2>üå°Ô∏è Hourly temperature & wind (next 24h)</h2>
        <canvas id="tempWindChart" class="chartSmall" aria-label="Hourly temperature and wind"></canvas>
        <div class="sub">Line: temperature (¬∞C). Bars: wind speed (km/h).</div>
      </div>
    </section>

    <section class="row" style="margin-top:14px">
      <div class="card">
        <h2>‚òÄÔ∏è Sun & üåô Moon (today)</h2>
        <div id="nowLine" class="sub">‚Äî</div>
        <div class="sub" id="sunLine">‚Äî</div>
        <div class="sub" id="moonLine">‚Äî</div>
        <div class="chips" id="uvChips"></div>
        <div class="sub" id="dailyTip" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <h2>üóìÔ∏è 7‚Äëday outlook</h2>
        <div class="days" id="daysStrip" aria-label="7 day forecast"></div>
      </div>
    </section>

    <section class="row" style="margin-top:14px">
      <div class="card">
        <h2>ü´ß Air quality (now) + Pollen</h2>
        <div id="aqBadge" class="badge">‚Äî</div>
        <div class="sub" id="aqLine">‚Äî</div>
        <div class="sub" id="pollenLine">‚Äî</div>
        <div class="sub">EU AQI (CAMS via Open‚ÄëMeteo): Good (0‚Äì20), Fair (20‚Äì40), Moderate (40‚Äì60), Poor (60‚Äì80), Very poor (80‚Äì100), Extremely poor (>100).</div>
      </div>
      <div class="card">
        <h2>üõ∞Ô∏è Radar</h2>
        <div class="radarWrap" id="radarWrap">
          <button id="radarToggle" class="btn">Show live radar</button>
          <div id="radarSlot"></div>
          <div class="sub">If embed is blocked, use: <a id="radarOpenLink" href="#" target="_blank" rel="noopener">Open radar</a>.</div>
        </div>
      </div>
    </section>

    <section class="row" style="margin-top:14px">
      <div class="card" id="alertsPanel" style="display:none">
        <h2>‚ö†Ô∏è Severe weather (details)</h2>
        <div class="sub" id="alertsSummary">‚Äî</div>
        <ul id="alertsList" class="sub" style="margin:6px 0 0 16px; padding:0"></ul>
        <div class="sub" style="margin-top:8px">Full details: <a href="https://www.meteoalarm.org/en/region/CZ" target="_blank" rel="noopener">Meteoalarm map</a>.</div>
      </div>
      <div class="card">
        <h2>üß≠ Useful links</h2>
        <ul class="sub" style="margin:0">
          <li><a href="https://www.chmi.cz/aktualni-situace/?l=en" target="_blank" rel="noopener">ƒåHM√ö current situation (official)</a></li>
          <li><a href="https://www.meteoalarm.org/en/region/CZ" target="_blank" rel="noopener">Meteoalarm map</a></li>
          <li><a href="https://www.chmi.cz/files/portal/docs/meteo/rad/inca-cz/?lang=EN" target="_blank" rel="noopener">ƒåHM√ö radar / nowcasting</a></li>
        </ul>
      </div>
    </section>

    <footer>
      <strong>Disclaimer.</strong> Experimental hobby project. Not official. No guarantee of accuracy, timeliness, or availability. Verify with ƒåHM√ö & Meteoalarm.<br/>
      <strong>Data.</strong> Open‚ÄëMeteo (forecast, AQ, pollen). Alerts via Meteoalarm (proxied). Radar ¬© ƒåHM√ö & partners. No personal data is collected.<br/>
      <strong>Contact.</strong> Support: <a href="mailto:matesaman9910@gmail.com">matesaman9910@gmail.com</a> ‚Ä¢ <strong>Copyright.</strong> ¬© 2025 matesaman9910. All rights reserved.
    </footer>
  </div>

  <div id="toast" class="toast" role="status">Data too old to decide. Refresh later.</div>

  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js" defer></script>
  <script>
  // ===== Config =====
  const LAT = 49.4551, LON = 17.4509; // P≈ôerov
  const PROXY_BASE = 'https://weatherwebsiteprerov.matejkratochvilbilina.workers.dev';
  const APP_VER = '1.10';
  const LOCALE = navigator.language || 'cs-CZ';
  const RADAR_URL = `https://radar.bourky.cz/index.php?img_to_load=10&lat=${LAT.toFixed(5)}&lon=${LON.toFixed(5)}&zoom=10&map_id=1&anim=1&repeat=0&last=0&l_type=0&l_res=0&fcst=1&prod=0&r_opa=25&l_opa=16&b_opa=100&menu_weather=0&menu_weathergraphs=0&menu_webcam=0&menu_cells=0&menu_blitzortung=0&menu_sivs=0&menu_estofex=0&menu_metar=0&menu_planes=0&menu_hydro=0&menu_aero=0&menu_radars=0&menu_wind=0&menu_airquality=0&menu_chasers=0&menu_daynight=1&synop_selected=T&gps=false`;

  const LOW_MOTION = window.matchMedia('(prefers-reduced-motion: reduce)').matches || (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4);

  // ===== Helpers =====
  const $ = (id)=> document.getElementById(id);
  const pad = (n)=> String(n).padStart(2,'0');
  const hourKeyLocal = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}`;
  const fmtTime = (s)=> { try{ const d=new Date(s); return d.toLocaleTimeString(LOCALE, {hour:'2-digit',minute:'2-digit'});}catch{ return '‚Äî'; } };
  const fmtDay = (s)=> { try{ const d=new Date(s); return d.toLocaleDateString(LOCALE, {weekday:'short'});}catch{ return '‚Äî'; } };

  function setAnswer(node, text, lvl){ node.textContent=text; node.className = 'answer '+(lvl||''); }
  function findCurrentHourIndex(times){
    const now = new Date(); const key = hourKeyLocal(now);
    const idx = times.findIndex(t => String(t).slice(0,13) === key);
    if(idx!==-1) return idx;
    let best=0,bestDiff=1e15; for(let i=0;i<times.length;i++){ const d=Math.abs(new Date(times[i])-now); if(d<bestDiff){bestDiff=d;best=i;} } return best;
  }

  // robust wet logic
  function isWet(h){
    const mm = (h.rain||0)+(h.showers||0)+(h.precipitation||0);
    const pop = h.precipitation_probability||0;
    return ((mm >= 0.2 && pop >= 40) || mm >= 0.6);
  }
  function wetPeriods(hours){
    const heavy = h => ((h.rain||0)+(h.showers||0)+(h.precipitation||0)) >= 1.0;
    const flags = hours.map((h,i)=>{
      if (isWet(h)) {
        const prevWet = i>0 && isWet(hours[i-1]);
        const nextWet = i<hours.length-1 && isWet(hours[i+1]);
        return prevWet || nextWet || heavy(h);
      }
      return false;
    });
    const res=[]; let cur=null; let peak=null; let prev=null;
    for(let i=0;i<hours.length;i++){
      const h = hours[i]; const mm=(h.rain||0)+(h.showers||0)+(h.precipitation||0); const pop=h.precipitation_probability||0;
      if(flags[i] && !cur){ cur={start:h.time}; peak={time:h.time, mm, pop}; }
      if(flags[i] && cur){ if(mm>peak.mm || pop>peak.pop) peak={time:h.time, mm, pop}; }
      if(!flags[i] && cur){ const nextWet = (i<hours.length-1) && flags[i+1]; if(nextWet){ continue; } cur.end = prev ? prev.time : h.time; cur.peak=peak; res.push(cur); cur=null; }
      prev = h;
    }
    if(cur){ cur.end = prev.time; cur.peak = peak; res.push(cur); }
    return res;
  }
  function confidenceFor(periods){
    if(!periods.length) return {label:'High (dry)', cls:''};
    const p = periods[0];
    const spanH = Math.max(1, (new Date(p.end)-new Date(p.start)) / 3600000);
    const pop = p.peak?.pop||0; const mm = p.peak?.mm||0;
    // heuristic: strong if heavy mm or high PoP and decent duration; low if very short and low PoP
    if (mm>=2 || (pop>=80 && spanH>=2)) return {label:'High', cls:''};
    if (pop>=55 && spanH>=1) return {label:'Medium', cls:''};
    return {label:'Low', cls:''};
  }

  function aqClass(euAQI){ if(euAQI==null) return {name:'‚Äî', cls:''}; if(euAQI>100) return {name:'Extremely poor', cls:'b-poor'}; if(euAQI>80) return {name:'Very poor', cls:'b-poor'}; if(euAQI>60) return {name:'Poor', cls:'b-poor'}; if(euAQI>40) return {name:'Moderate', cls:'b-mod'}; if(euAQI>20) return {name:'Fair', cls:'b-fair'}; return {name:'Good', cls:'b-good'}; }
  function feelsLikeC(tC, windKmh, rh){ const v=windKmh||0, rhp=rh||50; const v_ms=v/3.6; const t_wc = 13.12 + 0.6215*tC - 11.37*Math.pow(v_ms,0.16) + 0.3965*tC*Math.pow(v_ms,0.16); const tF=tC*9/5+32; const hiF = -42.379 + 2.04901523*tF + 10.14333127*rhp - 0.22475541*tF*rhp - 6.83783e-3*tF*tF - 5.481717e-2*rhp*rhp + 1.22874e-3*tF*tF*rhp + 8.5282e-4*tF*rhp*rhp - 1.99e-6*tF*tF*rhp*rhp; const t_hi=(hiF-32)*5/9; if(tC<=10 && v>=4.8) return Math.round(t_wc); if(tC>=27) return Math.round(t_hi); return Math.round(tC); }
  function wmoIcon(code){ const c=Number(code); if([0].includes(c)) return ['‚òÄÔ∏è','Clear']; if([1,2].includes(c)) return ['üå§Ô∏è','Partly']; if([3].includes(c)) return ['‚òÅÔ∏è','Cloudy']; if([45,48].includes(c)) return ['üå´Ô∏è','Fog']; if([51,53,55].includes(c)) return ['üå¶Ô∏è','Drizzle']; if([56,57].includes(c)) return ['üåßÔ∏è','Freezing drizzle']; if([61,63,65].includes(c)) return ['üåßÔ∏è','Rain']; if([66,67].includes(c)) return ['üåßÔ∏è','Freezing rain']; if([71,73,75,77].includes(c)) return ['üå®Ô∏è','Snow']; if([80,81,82].includes(c)) return ['üå¶Ô∏è','Showers']; if([85,86].includes(c)) return ['üå®Ô∏è','Snow showers']; if([95].includes(c)) return ['‚õàÔ∏è','Thunder']; if([96,99].includes(c)) return ['‚õàÔ∏è','Thunder + hail']; return ['‚ùì','‚Äî']; }
  function moonPhaseName(p){ if(p < 0.03 || p > 0.97) return 'New Moon'; if(p < 0.22) return 'Waxing crescent'; if(p < 0.28) return 'First quarter'; if(p < 0.47) return 'Waxing gibbous'; if(p < 0.53) return 'Full Moon'; if(p < 0.72) return 'Waning gibbous'; if(p < 0.78) return 'Last quarter'; return 'Waning crescent'; }

  // ===== Data fetchers =====
  const LSK='prerov-v1-cache';
  async function retry(fn, n=1){ for(let i=0;i<=n;i++){ try{ return await fn(); }catch(e){ if(i===n) throw e; } } }
  async function fetchForecast(){
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = new URLSearchParams({
      latitude: LAT, longitude: LON, timezone: 'auto', forecast_days: 7,
      hourly: ['precipitation_probability','precipitation','rain','showers','temperature_2m','relative_humidity_2m','cloud_cover','pressure_msl','wind_speed_10m','wind_gusts_10m','uv_index'].join(','),
      daily: ['sunrise','sunset','uv_index_max','precipitation_sum','precipitation_probability_max','temperature_2m_max','temperature_2m_min','weathercode'].join(','),
      current: ['time','temperature_2m','wind_speed_10m','cloud_cover','pressure_msl','relative_humidity_2m','uv_index'].join(',')
    }).toString();
    const r = await fetch(url, {cache:'no-cache'}); if(!r.ok) throw new Error('forecast '+r.status); return r.json();
  }
  async function fetchAQ(){
    const url = new URL('https://air-quality-api.open-meteo.com/v1/air-quality');
    url.search = new URLSearchParams({ latitude: LAT, longitude: LON, timezone: 'auto',
      hourly: 'pm2_5,ozone,european_aqi,alder_pollen,birch_pollen,grass_pollen,ragweed_pollen',
      current: 'time,pm2_5,ozone,european_aqi,alder_pollen,birch_pollen,grass_pollen,ragweed_pollen' }).toString();
    const r = await fetch(url, {cache:'no-cache'}); if(!r.ok) throw new Error('air '+r.status); return r.json();
  }

  // ===== Alerts =====
  async function fetchAlerts(){
    try{
      const r = await fetch(PROXY_BASE + '/meteoalarm-cz?region=olomoucky', {cache:'no-cache'});
      if(!r.ok) throw new Error('alerts '+r.status);
      const x = await r.json();
      const valid = (x.items||[]).filter(it => { const exp = it.expires ? Date.parse(it.expires) : null; return !exp || exp > Date.now(); });
      if(!valid.length){ setAlert('No active alerts for P≈ôerov', 'green', null); $('alertsPanel').style.display='none'; return; }
      const firstExp = valid[0]?.expires ? new Date(valid[0].expires) : null;
      setAlert(valid[0]?.title || 'Weather alert', x.bestLevel || valid[0]?.level || 'yellow', firstExp);

      const panel=$('alertsPanel'); const list=$('alertsList'); const sum=$('alertsSummary'); panel.style.display='block'; list.innerHTML='';
      sum.innerHTML = `Level: <span class="level ${x.bestLevel}">${(x.bestLevel||'').toUpperCase()}</span> ‚Ä¢ ${valid.length} item(s)`;
      valid.slice(0,6).forEach(it=>{
        const li=document.createElement('li');
        const exp = it.expires ? new Date(it.expires).toLocaleString([], {hour:'2-digit',minute:'2-digit', day:'2-digit', month:'short'}) : '‚Äî';
        li.innerHTML = `<span>${it.title||'Alert'}</span> <span class="level ${it.level||'yellow'}">${(it.level||'').toUpperCase()}</span> <span class="sub">until ${exp}</span>`;
        list.appendChild(li);
      });
      const bar = $('alertBar'); bar.onclick = () => bar.classList.toggle('expand');
    }catch{
      setAlert('Alerts: open Meteoalarm (tap)', 'gray', null); const bar = $('alertBar'); bar.onclick = () => window.open('https://www.meteoalarm.org/en/region/CZ','_blank');
    }
  }
  function setAlert(text, level, expires){
    const bar=$('alertBar'); bar.className='banner '+(level||'gray'); $('alertText').textContent=text;
    const until = $('alertUntil'); if(expires){ until.style.display='inline-block'; until.textContent = 'until '+ expires.toLocaleTimeString(LOCALE,{hour:'2-digit',minute:'2-digit'}); } else { until.style.display='none'; }
    let glow='transparent', alpha='0%'; if(level==='yellow'){ glow='#f59e0b'; alpha='35%'; } else if(level==='orange'){ glow='#fb923c'; alpha='45%'; } else if(level==='red'){ glow='#ef4444'; alpha='55%'; }
    document.documentElement.style.setProperty('--glow', glow); document.documentElement.style.setProperty('--glowAlpha', alpha);
  }

  // ===== Charts & animation =====
  let lastHours24 = null;
  function animateChart(drawFn, duration=700){ if(LOW_MOTION){ drawFn(1); return; } const t0=performance.now(); function frame(now){ const p=Math.min(1,(now-t0)/duration); drawFn(p); if(p<1) requestAnimationFrame(frame);} requestAnimationFrame(frame); }
  function chartDPR(){ const small = Math.min(window.innerWidth, window.innerHeight) < 420; return small ? Math.min(1.25, window.devicePixelRatio||1) : Math.min(1.5, window.devicePixelRatio||1); }
  function drawRainChart(hours){ const c=$('rainChart'); const ctx=c.getContext('2d'); const DPR=chartDPR(); c.width=Math.floor(c.clientWidth*DPR); c.height=Math.floor(c.clientHeight*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); const W=c.clientWidth,H=c.clientHeight; ctx.clearRect(0,0,W,H); if(!hours||!hours.length){ ctx.fillStyle='#9fb0ff'; ctx.fillText('no data',8,16); return;} const pad=32; const barW=(W-pad*2)/Math.max(1,hours.length); const mm=hours.map(h=> (h.rain||0)+(h.showers||0)+(h.precipitation||0)); const pop=hours.map(h=> h.precipitation_probability||0); const maxMM=Math.max(0.8,...mm); animateChart(p=>{ ctx.clearRect(0,0,W,H); for(let i=0;i<mm.length;i++){ const x=pad+i*barW; const h=(mm[i]/maxMM)*(H-pad*2)*p; ctx.fillStyle='#77a8ff'; ctx.fillRect(x,H-pad-h,barW*0.6,h);} ctx.beginPath(); for(let i=0;i<pop.length;i++){ const x=pad+i*barW+barW*0.3; const y=H-pad-(pop[i]/100)*(H-pad*2)*p; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.strokeStyle='#f5d061'; ctx.lineWidth=2; ctx.stroke(); ctx.fillStyle='#9fb0ff'; ctx.font='13px system-ui'; for(let i=0;i<hours.length;i+=3){ const x=pad+i*barW+barW*0.3; const t=String(new Date(hours[i].time).getHours()).padStart(2,'0'); ctx.fillText(t,x-7,H-8);} }); }
  function drawTempWindChart(hours){ const c=$('tempWindChart'); const ctx=c.getContext('2d'); const DPR=chartDPR(); c.width=Math.floor(c.clientWidth*DPR); c.height=Math.floor(c.clientHeight*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); const W=c.clientWidth,H=c.clientHeight; ctx.clearRect(0,0,W,H); if(!hours||!hours.length){ ctx.fillStyle='#9fb0ff'; ctx.fillText('no data',8,16); return;} const pad=32; const n=Math.max(1,hours.length); const step=(W-pad*2)/n; const temps=hours.map(h=> h.temperature_2m||0); const winds=hours.map(h=> h.wind_speed_10m||0); const tMin=Math.min(...temps)-1, tMax=Math.max(...temps)+1; const wMax=Math.max(20,...winds); const yT=v=> H-pad-((v-tMin)/(tMax-tMin))*(H-pad*2); const yW=v=> H-pad-(v/wMax)*(H-pad*2); animateChart(p=>{ ctx.clearRect(0,0,W,H); ctx.fillStyle='#9fb0ff55'; for(let i=0;i<winds.length;i++){ const x=pad+i*step; const h=yW(0)-yW(winds[i]*p); ctx.fillRect(x,yW(winds[i]*p),step*0.6,h);} ctx.beginPath(); for(let i=0;i<temps.length;i++){ const x=pad+i*step+step*0.3; const y=yT(temps[i]); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.strokeStyle='#ffd166'; ctx.lineWidth=2; ctx.stroke(); ctx.fillStyle='#9fb0ff'; ctx.font='13px system-ui'; for(let i=0;i<hours.length;i+=3){ const x=pad+i*step+step*0.3; const t=String(new Date(hours[i].time).getHours()).padStart(2,'0'); ctx.fillText(t,x-7,H-8);} }); }
  function redrawCharts(){ if(lastHours24){ drawRainChart(lastHours24); drawTempWindChart(lastHours24); } }
  window.addEventListener('resize', ()=> { clearTimeout(window.__rsz); window.__rsz=setTimeout(redrawCharts, 120); });

  // ===== Render =====
  function renderFromCache(){ try{ const s=localStorage.getItem(LSK); if(!s) return; const {fc, aq, ts}=JSON.parse(s); if(Date.now()-ts>90*60*1000) return; paint(fc, aq, true); }catch{} }

  function paint(fc, aq, cached=false){
    // Freshness & window
    const hours = fc.hourly.time; const firstH = new Date(hours[0]); const lastH = new Date(hours[hours.length-1]);
    const ageMin = Math.round((Date.now() - new Date(fc.current?.time || hours[0]).getTime())/60000);
    const status = $('statusDot'); let st='green'; if(ageMin>120) st='red'; else if(ageMin>30) st='yellow'; status.style.background = st==='green'?'#16a34a':st==='yellow'?'#f59e0b':'#ef4444';
    $('asof').innerHTML = `updated ${new Date().toLocaleTimeString(LOCALE,{hour:'2-digit',minute:'2-digit'})} ‚Ä¢ window ${firstH.toLocaleDateString(LOCALE,{weekday:'short'})} ${String(firstH.getHours()).padStart(2,'0')}:00 ‚Äì ${lastH.toLocaleDateString(LOCALE,{weekday:'short'})} ${String(lastH.getHours()).padStart(2,'0')}:00 ‚Ä¢ v${APP_VER} <span class="statusDot" style="background:${status.style.background}"></span>`;

    // Guard stale data
    if(lastH < new Date(Date.now()-2*3600*1000)){
      toast('Data too old to decide. Refresh later.'); setAnswer($("rainToday"),'‚Äî',''); $("reasonToday").textContent=''; $("highlightsToday").textContent='‚Äî';
    }

    // Windows from NOW
    const idxNow = findCurrentHourIndex(hours);
    const endOfTodayIdx = (()=>{ const d=new Date(hours[idxNow]); d.setHours(23,59,59,999); for(let i=hours.length-1;i>=0;i--){ const ti=new Date(hours[i]); if(ti.getFullYear()===d.getFullYear() && ti.getMonth()===d.getMonth() && ti.getDate()===d.getDate()) return i; } return Math.min(idxNow+23,hours.length-1); })();
    function pack(start,end){ const out=[]; const H=fc.hourly; for(let i=start;i<=end;i++){ out.push({ time:hours[i], precipitation:H.precipitation?.[i], precipitation_probability:H.precipitation_probability?.[i], rain:H.rain?.[i], showers:H.showers?.[i], temperature_2m:H.temperature_2m?.[i], relative_humidity_2m:H.relative_humidity_2m?.[i], cloud_cover:H.cloud_cover?.[i], pressure_msl:H.pressure_msl?.[i], wind_speed_10m:H.wind_speed_10m?.[i], wind_gusts_10m:H.wind_gusts_10m?.[i], uv_index:H.uv_index?.[i] }); } return out; }
    const todayH = pack(idxNow, endOfTodayIdx);
    const tomorrowStart = endOfTodayIdx+1; const tomorrowEnd = Math.min(tomorrowStart+23, hours.length-1); const tomorrowH = pack(tomorrowStart, tomorrowEnd);

    // YES/NO + confidence
    const perT = wetPeriods(todayH); const perTm = wetPeriods(tomorrowH);
    const yesT = perT.length>0; setAnswer($("rainToday"), yesT?'YES':'NO', yesT?'bad':'ok');
    $("reasonToday").innerHTML = yesT ? `Starts ~ <strong>${fmtTime(perT[0].start)}</strong> ‚Ä¢ Peak ~ <strong>${fmtTime(perT[0].peak.time)}</strong> ‚Äî ${Math.round(perT[0].peak.pop||0)}% ‚Ä¢ ${(perT[0].peak.mm||0).toFixed(1)} mm/h ‚Ä¢ Ends ~ <strong>${fmtTime(perT[0].end)}</strong>` : 'No significant rain expected.';
    $("highlightsToday").textContent = perT.slice(0,3).map(x=> `${fmtTime(x.start)}‚Äì${fmtTime(x.end)}`).join(' ‚Ä¢ ') || 'All hours look dry.';
    const confT = confidenceFor(perT); $("confToday").textContent = `Confidence ${confT.label}`;

    const yesTm = perTm.length>0; setAnswer($("rainTomorrow"), yesTm?'YES':'NO', yesTm?'warn':'ok');
    $("reasonTomorrow").innerHTML = yesTm ? `Starts ~ <strong>${fmtTime(perTm[0].start)}</strong> ‚Ä¢ Peak ~ <strong>${fmtTime(perTm[0].peak.time)}</strong> ‚Äî ${Math.round(perTm[0].peak.pop||0)}% ‚Ä¢ ${(perTm[0].peak.mm||0).toFixed(1)} mm/h ‚Ä¢ Ends ~ <strong>${fmtTime(perTm[0].end)}</strong>` : 'No significant rain expected.';
    $("highlightsTomorrow").textContent = perTm.slice(0,3).map(x=> `${fmtTime(x.start)}‚Äì${fmtTime(x.end)}`).join(' ‚Ä¢ ') || '‚Äî';
    const confTm = confidenceFor(perTm); $("confTomorrow").textContent = `Confidence ${confTm.label}`;

    // Sun & Moon
    try{ const now=new Date(); const sun=SunCalc.getTimes(now, LAT, LON); $("sunLine").textContent=`Sunrise ${fmtTime(sun.sunrise)} ‚Ä¢ Sunset ${fmtTime(sun.sunset)} (local)`; const moonT=SunCalc.getMoonTimes(now,LAT,LON); const mi=SunCalc.getMoonIllumination(now); const phase=moonPhaseName(mi.phase); let moonTxt=`${phase}: ${Math.round(mi.fraction*100)}% lit`; if(moonT.rise) moonTxt+=` ‚Ä¢ Rise ${fmtTime(moonT.rise)}`; if(moonT.set) moonTxt+=` ‚Ä¢ Set ${fmtTime(moonT.set)}`; $("moonLine").textContent=moonTxt; }catch{}

    // Now line + chips (pressure trend smoothed)
    const idx = idxNow; const t=fc.hourly.temperature_2m?.[idx]; const w=fc.hourly.wind_speed_10m?.[idx]; const rh=fc.hourly.relative_humidity_2m?.[idx]; const cloud=fc.hourly.cloud_cover?.[idx]; const p=fc.hourly.pressure_msl?.[idx];
    $("nowLine").textContent = `Now: ${t!=null? Math.round(t)+'¬∞C':'‚Äî'} (feels ${feelsLikeC(t||0,w||0,rh||50)}¬∞C), wind ${w!=null? Math.round(w)+' km/h':'‚Äî'}, clouds ${cloud!=null? Math.round(cloud)+'%':'‚Äî'}, pressure ${p!=null? Math.round(p)+' hPa':'‚Äî'}`;
    const uvNow = fc.current?.uv_index; const uvMax = fc.daily?.uv_index_max?.[0];
    $("uvChips").innerHTML = `<span class="chip">UV now ${uvNow!=null?uvNow.toFixed(1):'‚Äî'}</span><span class="chip">UV max ${uvMax!=null?uvMax.toFixed(1):'‚Äî'}</span>`;
    // pressure 3h smoothed
    const p3idx = Math.max(0, idx-3); const p6idx = Math.max(0, idx-6); const p3=fc.hourly.pressure_msl?.[p3idx]; const p6=fc.hourly.pressure_msl?.[p6idx]; if(p!=null && p3!=null){ const d3=Math.round(p-p3); const d6 = (p6!=null)?Math.round(p-p6):null; const arrow = d3>0?'‚ñ≤':(d3<0?'‚ñº':'‚Üí'); $("uvChips").innerHTML += ` <span class="chip">Pressure ${arrow} ${d3} hPa/3h${d6!=null?`, ${d6} hPa/6h`:''}</span>`; }

    // Charts ‚Üí next 24h from now
    const end = Math.min(idxNow+23, hours.length-1); lastHours24 = pack(idxNow,end); drawRainChart(lastHours24); drawTempWindChart(lastHours24);

    // AQI + pollen
    const ai=aq.hourly||{}; const aTimes=ai.time||[]; const aIdx=findCurrentHourIndex(aTimes); const pm = ai.pm2_5?.[aIdx]; const o3= ai.ozone?.[aIdx]; const euaqi = ai.european_aqi?.[aIdx]; const cl = aqClass(euaqi); const badge = $("aqBadge"); badge.textContent = cl.name + (euaqi!=null? ` (${Math.round(euaqi)})`:''); badge.className = 'badge '+cl.cls; $("aqLine").textContent = `PM‚ÇÇ.‚ÇÖ ${pm!=null? Math.round(pm)+' ¬µg/m¬≥':'‚Äî'} ‚Ä¢ O‚ÇÉ ${o3!=null? Math.round(o3)+' ¬µg/m¬≥':'‚Äî'}`;
    const alder=ai.alder_pollen?.[aIdx], birch=ai.birch_pollen?.[aIdx], grass=ai.grass_pollen?.[aIdx], rag=ai.ragweed_pollen?.[aIdx]; const polTxt=[alder!=null?`Alder ${Math.round(alder)}`:null,birch!=null?`Birch ${Math.round(birch)}`:null,grass!=null?`Grass ${Math.round(grass)}`:null,rag!=null?`Ragweed ${Math.round(rag)}`:null].filter(Boolean).join(' ‚Ä¢ '); $("pollenLine").textContent = polTxt || 'Pollen: ‚Äî';

    // 7‚Äëday
    const d = fc.daily||{}; const n=Math.min(7,(d.time||[]).length); let html=''; for(let i=0;i<n;i++){ const [ico,label]=wmoIcon(d.weathercode?.[i]); const day=fmtDay(d.time?.[i]); const hi=d.temperature_2m_max?.[i]; const lo=d.temperature_2m_min?.[i]; const pop=d.precipitation_probability_max?.[i]; html += `<div class="day"><div class="sub">${day}</div><div class="w">${ico}</div><div>${label}</div><div class="t"><strong>${Math.round(hi)}¬∞</strong> / ${Math.round(lo)}¬∞</div><div class="sub">PoP ${pop!=null?pop+'%':'‚Äî'}</div></div>`; } $("daysStrip").innerHTML = html;
  }

  function computeTip(fc, aq){ try{ const times=fc.hourly.time; const idx=findCurrentHourIndex(times); const p=fc.hourly.pressure_msl?.[idx]; const p3=fc.hourly.pressure_msl?.[Math.max(0, idx-3)]; const dp = (p!=null && p3!=null) ? (p - p3) : null; const uvMax = fc.daily?.uv_index_max?.[0]; const gust = fc.hourly.wind_gusts_10m?.[idx]; const rainNow = (fc.hourly.rain?.[idx]||0)+(fc.hourly.showers?.[idx]||0)+(fc.hourly.precipitation?.[idx]||0); const ai=aq.hourly||{}; const aTimes=ai.time||[]; const aIdx=findCurrentHourIndex(aTimes); const euaqi = ai.european_aqi?.[aIdx]; if(euaqi!=null && euaqi>60) return `Tip: Air quality is ${Math.round(euaqi)} (Poor). Sensitive people should limit outdoor exertion.`; if(gust!=null && gust>=60) return `Tip: Strong gusts (~${Math.round(gust)} km/h). Secure loose items and be careful on bikes.`; if(dp!=null && dp<=-3) return `Tip: Notable pressure drop (~${Math.round(-dp)} hPa/3h). Some people feel headaches‚Äîhydrate and pace yourself.`; if(uvMax!=null && uvMax>=6) return `Tip: High UV today (max ~${uvMax.toFixed(1)}). Sun protection around midday helps.`; if(rainNow>=0.2) return `Tip: Ongoing rain‚Äîkeep an umbrella; roads may be slick.`; return `Tip: All quiet‚Äîno strong signals from AQI, wind, UV, or pressure.`; }catch{ return `Tip: ‚Äî`; } }

  // ===== Interactions =====
  function revealOnScroll(){ const obs=new IntersectionObserver(entries=>{ for(const e of entries){ if(e.isIntersecting){ e.target.classList.add('reveal'); obs.unobserve(e.target);} } },{threshold:.15}); document.querySelectorAll('.card').forEach(el=> obs.observe(el)); }
  function setupShare(){ $('shareBtn').onclick = async ()=>{ const yes=$('rainToday').textContent.trim(); let extra=''; const txtDetail=$('reasonToday').innerText.replace(/\s+/g,' ').trim(); if(yes==='YES'){ extra = ' ' + txtDetail; } const txt = `P≈ôerov weather: Rain today: ${yes}.` + extra; const data={title:'P≈ôerov Weather', text:txt, url:location.href}; if(navigator.share){ try{ await navigator.share(data);}catch{} } else { try{ await navigator.clipboard.writeText(`${txt} ‚Äî ${location.href}`); $('shareBtn').textContent='Copied!'; setTimeout(()=>{$('shareBtn').textContent='Share'},1200);}catch{} } }; }
  function setupRadar(){ const link=$('radarOpenLink'); link.href=RADAR_URL; const btn=$('radarToggle'); const slot=$('radarSlot'); let shown=false; btn.onclick=()=>{ if(!shown){ const ifr=document.createElement('iframe'); ifr.className='radar'; ifr.setAttribute('sandbox','allow-scripts allow-same-origin'); ifr.setAttribute('referrerpolicy','no-referrer'); ifr.loading='lazy'; ifr.title='CZ radar'; ifr.src=RADAR_URL; slot.appendChild(ifr); btn.textContent='Hide live radar'; shown=true; } else { slot.innerHTML=''; btn.textContent='Show live radar'; shown=false; } }; }

  // auto refresh
  let refreshTimer=null; function scheduleAutoRefresh(){ if(document.visibilityState==='visible'){ refreshTimer=setTimeout(()=>init(true), 20*60*1000); } }
  document.addEventListener('visibilitychange', ()=>{ if(refreshTimer) clearTimeout(refreshTimer); scheduleAutoRefresh(); });

  function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 4000); }

  async function init(isRefresh=false){ revealOnScroll(); setupShare(); setupRadar(); if(!isRefresh) $('asof').textContent='loading‚Ä¶'; try{ const [fc, aq] = await Promise.all([retry(fetchForecast,1), retry(fetchAQ,1)]); try{ localStorage.setItem(LSK, JSON.stringify({fc, aq, ts: Date.now()})); }catch{} paint(fc, aq, false); }catch(err){ $('asof').textContent='failed'; } fetchAlerts(); if(isRefresh) toast('Auto‚Äërefreshed'); scheduleAutoRefresh(); }

  renderFromCache();
  init();
  </script>
</body>
</html>
